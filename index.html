<!doctype html>
<html>
<head>
	<title>Socket.IO chat</title>
	<style>
		* { margin: 0; padding: 0; box-sizing: border-box; }
		body { font: 13px Helvetica, Arial; }
		form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
		form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
		form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
		#messages { list-style-type: none; margin: 0; padding: 0; }
		#messages li { padding: 5px 10px; }
		#messages li:nth-child(odd) { background: #eee; }
	</style>
</head>
<body>
	<ul id="messages"></ul>
	<form action="">
		<input id="m" autocomplete="off" /><button>Send</button>
	</form>

	<script src="/socket.io/socket.io.js"></script>
	<script src="/msgpack.codec.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
	<script>
		var obj = {
			aaa: {
				count: 123,
				name: "テスト１",
				result: false
			},
			bbb: {
				count: 456,
				name: "テスト２",
				result: true
			},
			ccc: {
				count: 789,
				name: "テスト３",
				param: {
					ary: ["a", "b", "c"],
					name: "テスト４"
				},
				result: true
			}
		};


		// connection 接続
		var socket = io();

		$('form').submit(function () {
			// client send
			//socket.emit('chat', $('#m').val());
		    var json = JSON.stringify(obj);
		    console.log(json);
		    var binary = msgpack.pack(json);
		    console.log(binary);
		    socket.emit('chat', binary);
			$('#m').val('').focus();
			return false;
		});

		$('#m').focus();

		// server push
		socket.on('chat', function (data) {
		    console.log(data);
		    var unpack = msgpack.unpack(data);
			console.log(unpack);
			$('#messages').append($('<li>').text(unpack));
		});


		socket.on('connect', function () { console.log('[connect]'); });
		socket.on('error', function(err) { console.log('[error]' + err); });
		socket.on('disconnect', function () { console.log('[disconnect]'); });
		socket.on('reconnect', function (num) { console.log('[reconnect]' + num); });
		socket.on('reconnect_attempt', function () { console.log('[reconnect_attempt]'); });
		socket.on('reconnecting', function (num) { console.log('[reconnecting]' + num); });
		socket.on('reconnect_error', function (err) { console.log('[reconnect_error]' + err); });
		socket.on('reconnect_failed', function () { console.log('[reconnect_failed]'); });
	</script>
</body>
</html>
